{% extends 'base.html' %}
{% block title %}Edit Article - Management{% endblock %}
{% load static %}

{% block content %}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
      <h1 class="h3 mb-0">Edit Article</h1>
      <a href="{% url 'articles_list' %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to List
      </a>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Edit Article: {{ article.title }}</h3>
        </div>
        <div class="card-body">
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
            {% endfor %}
          {% endif %}

          <form method="POST" id="editArticleForm" enctype="multipart/form-data" novalidate>
            {% csrf_token %}
            
            <!-- Company -->
            <div class="form-group">
              <label for="company_id">Company *</label>
              <select class="form-control" id="company_id" name="company_id" required>
                <option value="">-- Select Company --</option>
                {% for comp in companies %}
                  <option value="{{ comp.md5_id }}" {% if comp.id == article.company.id %}selected{% endif %}>
                    {{ comp.name }} ({{ comp.email }})
                  </option>
                {% endfor %}
              </select>
            </div>

            <!-- Title -->
            <div class="form-group">
              <label for="title">Article Title *</label>
              <input type="text" class="form-control" id="title" name="title"
                     value="{{ article.title }}" required maxlength="255">
            </div>

            <!-- Category -->
            <div class="form-group">
              <label for="category">Category *</label>
              <select class="form-control" id="category" name="category" required>
                <option value="">-- Select Category --</option>
                {% for value, label in categories %}
                  <option value="{{ value }}" {% if article.category == value %}selected{% endif %}>
                    {{ label }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <!-- Content -->
            <div class="form-group">
              <label for="content">Content *</label>
              <textarea class="form-control" id="content" name="content" rows="10" required>{{ article.content }}</textarea>
            </div>

            <!-- Current Image -->
            {% if article.image %}
            <div class="form-group">
                <label>Current Image</label>
                <div class="text-center">
                    <img src="{{ article.image.url }}" alt="Current image" class="img-thumbnail" style="max-height: 200px;">
                </div>
                <div class="text-center mt-2">
                    <a href="{{ article.image.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                        <i class="fas fa-external-link-alt"></i> View Full Image
                    </a>
                    <button type="button" class="btn btn-sm btn-outline-info copy-image-link" 
                            data-image-url="{{ article.image.url }}">
                        <i class="fas fa-copy"></i> Copy Link
                    </button>
                </div>
                <div class="mt-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="remove_image" name="remove_image">
                        <label class="form-check-label text-danger" for="remove_image">Remove current image</label>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Image Upload -->
            <div class="form-group">
              <label for="image">Replace Image (Optional)</label>
              <div class="custom-file">
                <input type="file" class="custom-file-input" id="image" name="image" accept="image/*">
                <label class="custom-file-label" for="image">Choose image file...</label>
              </div>
              <small class="form-text text-muted">
                <i class="fas fa-info-circle"></i> Recommended size: 1200x630px (16:9 ratio). Max size: 2MB.
              </small>

              <input type="file" id="croppedFileInput" name="cropped_image" style="display: none;">

              <!-- New Image Preview -->
              <div id="imagePreviewSection" class="mt-3" style="display: none;">
                <h6>New Image Preview</h6>
                <div class="text-center">
                  <img id="previewImage" src="#" alt="Preview" class="img-fluid rounded" style="max-height: 200px; display: none;">
                </div>
                <!-- View New Image Link -->
                <div id="viewImageLinkContainer" class="text-center mt-2" style="display: none;">
                  <a href="#" id="viewImageLink" class="btn btn-sm btn-outline-primary" target="_blank">
                    <i class="fas fa-external-link-alt"></i> View Full New Image
                  </a>
                </div>
              </div>

              <div id="fileSizeError" class="text-danger mt-2" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i> File size exceeds 2MB limit.
              </div>
              <div id="fileTypeError" class="text-danger mt-2" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i> Only image files are allowed.
              </div>
            </div>

            <!-- Status -->
            <div class="form-group">
              <label for="status">Status</label>
              <select class="form-control" id="status" name="status">
                <option value="1" {% if article.status == '1' %}selected{% endif %}>Active</option>
                <option value="0" {% if article.status == '0' %}selected{% endif %}>Inactive</option>
              </select>
            </div>

            <!-- Actions -->
            <div class="form-group">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Update Article
              </button>
              <a href="{% url 'articles_list' %}" class="btn btn-secondary">Cancel</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Crop Modal -->
<div class="modal fade" id="cropModal" tabindex="-1" aria-labelledby="cropModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cropModalLabel">Crop Image</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="text-center">
          <img id="cropImage" src="#" alt="Crop preview" style="max-width: 100%; max-height: 500px;">
        </div>
        <div class="mt-3">
          <small class="text-muted">Drag to crop the image. Aspect ratio: 16:9</small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="cropBtn">Crop Image</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- CropperJS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
  $(document).ready(function () {
    let cropper;
    let currentObjectUrl = null;

    // File input change event
    $('#image').on('change', function(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Check file type
      const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
      if (!allowedTypes.includes(file.type)) {
        $('#fileTypeError').show();
        $(this).val('');
        $(this).next('.custom-file-label').html('Choose image file...');
        return;
      }
      
      // Check file size (2MB)
      if (file.size > 2 * 1024 * 1024) {
        $('#fileSizeError').show();
        $(this).val('');
        $(this).next('.custom-file-label').html('Choose image file...');
        return;
      }

      // Hide any previous errors
      $('#fileTypeError').hide();
      $('#fileSizeError').hide();

      // Update file label
      $(this).next('.custom-file-label').addClass("selected").html(file.name);

      const reader = new FileReader();
      reader.onload = function(e) {
        $('#cropImage').attr('src', e.target.result);
        $('#cropModal').modal('show');

        if (cropper) {
          cropper.destroy();
        }
        
        cropper = new Cropper(document.getElementById('cropImage'), {
          aspectRatio: 16 / 9,
          viewMode: 1,
          autoCropArea: 0.8,
        });
      };
      reader.readAsDataURL(file);
    });

    // Crop button click event
    $('#cropBtn').on('click', function() {
      cropper.getCroppedCanvas({
        width: 1200,
        height: 675,
      }).toBlob(function(blob) {
        // Create file with proper naming (matching your upload_to function)
        const timestamp = new Date().getTime();
        const fileName = `cropped_${timestamp}.jpg`;
        const file = new File([blob], fileName, { type: "image/jpeg" });

        // Put cropped file into the main file input
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        $('#image')[0].files = dataTransfer.files;

        // Update file label
        $('#image').next('.custom-file-label').addClass("selected").html(fileName);

        // Create temporary blob URL for preview
        if (currentObjectUrl) {
          URL.revokeObjectURL(currentObjectUrl);
        }
        
        currentObjectUrl = URL.createObjectURL(blob);
        
        // Show preview with jQuery
        $('#previewImage')
          .attr('src', currentObjectUrl)
          .show();
        
        $('#imagePreviewSection').show();
        
        // Setup temporary view link
        $('#viewImageLink')
          .attr('href', currentObjectUrl)
          .attr('title', 'Preview of cropped image');
        
        $('#viewImageLinkContainer').show();

        $('#cropModal').modal('hide');

        // Destroy the cropper instance after cropping
        if (cropper) {
          cropper.destroy();
          cropper = null;
        }

      }, "image/jpeg", 0.9);
    });

    // When the crop modal is hidden, destroy the cropper instance
    $('#cropModal').on('hidden.bs.modal', function () {
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
    });

    // Copy image link functionality
    $('.copy-image-link').on('click', function() {
      const imageUrl = $(this).data('image-url');
      
      // Use the modern Clipboard API
      navigator.clipboard.writeText(imageUrl).then(function() {
        // Show success feedback
        showTempAlert('Image URL copied to clipboard!', 'success');
      }).catch(function(err) {
        console.error('Failed to copy image URL: ', err);
        // Fallback for older browsers
        fallbackCopyTextToClipboard(imageUrl);
      });
    });

    // Form validation for editArticleForm
    $('#editArticleForm').on('submit', function(e) {
      // Clean up blob URL before submission
      if (currentObjectUrl) {
        URL.revokeObjectURL(currentObjectUrl);
      }

      let valid = true;
      $('.text-danger.small').remove();

      const company = $('#company_id');
      const title = $('#title');
      const category = $('#category');
      const content = $('#content');

      if (company.val().trim() === '') {
        showError(company, 'Please select a company.');
        valid = false;
      }

      if (title.val().trim() === '') {
        showError(title, 'Please enter article title.');
        valid = false;
      }

      if (category.val().trim() === '') {
        showError(category, 'Please select a category.');
        valid = false;
      }

      if (content.val().trim() === '') {
        showError(content, 'Please enter article content.');
        valid = false;
      }

      if (!valid) {
        e.preventDefault();
      }
    });

    function showError(element, message) {
      const error = $('<small>', {
        class: 'text-danger small d-block mt-1',
        text: message
      });
      element.closest('.form-group').append(error);
    }

    // Unsaved changes warning
    let formChanged = false;
    $('#editArticleForm').on('change keyup', function() {
      formChanged = true;
    });

    $(window).on('beforeunload', function() {
      if (formChanged) {
        return 'You have unsaved changes. Are you sure you want to leave?';
      }
    });

    $('#editArticleForm').on('submit', function() {
      formChanged = false;
    });

    // Helper functions
    function fallbackCopyTextToClipboard(text) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.position = "fixed";
      textArea.style.opacity = 0;
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          showTempAlert('Image URL copied to clipboard!', 'success');
        }
      } catch (err) {
        showTempAlert('Failed to copy image URL. Please copy it manually.', 'error');
      }
      
      document.body.removeChild(textArea);
    }

    function showTempAlert(message, type) {
      const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
      const alert = $('<div>', {
        class: `alert ${alertClass} alert-dismissible fade show position-fixed`,
        css: {
          top: '20px', 
          right: '20px', 
          'z-index': '9999',
          'min-width': '300px'
        },
        html: `
          <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'}"></i> 
          ${message}
          <button type="button" class="close" data-dismiss="alert">
            <span aria-hidden="true">&times;</span>
          </button>
        `
      });
      
      $('body').append(alert);
      alert.fadeIn();
      
      setTimeout(function() {
        alert.fadeOut(function() {
          $(this).remove();
        });
      }, 3000);
    }
  });
</script>

<style>
.form-group { 
  margin-bottom: 1.5rem; 
}
.custom-file-label::after { 
  content: "Browse"; 
}
#previewImage {
  border: 2px solid #dee2e6;
  border-radius: 8px;
  padding: 5px;
  background-color: #f8f9fa;
}
.cropper-view-box, .cropper-face { 
  border-radius: 4px; 
}
#viewImageLinkContainer {
  margin-top: 10px;
}
</style>
{% endblock %}

